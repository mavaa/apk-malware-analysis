import sqlite3
import requests
import os

# Sqlite file
dbfile='androzoo.sqlite'

con = sqlite3.Connection(dbfile)
cur = con.cursor()

mode=input("Do you want (m)alware, (c)lean apps or (b)oth?")

query="select pkg_name, sha256 from apps"

if mode == 'm':
    print("Getting malware apps")
    query+=" where vt_detection = 1"
elif mode == 'c':
    print("Getting clean apps")
    query+=" where vt_detection = 0"
else:
    mode='b'
    print("Getting all types of apps")

query+=" order by random() limit 10;"

dl=input("Do you want to download these apps?(y/n)")

apps=cur.execute(query)

if dl == 'y':
    # Get API key from user
    apikey=input("Please enter your api key:")

    # Alternative solution, put key in a 'apikey.txt' file (ignored by git)
    # apikey=open("apikey.txt").read().strip()

    url="https://androzoo.uni.lu/api/download?apikey=" + apikey + "&sha256="

    dlfolder="downloads/" + mode + "/"

    if not os.path.exists(dlfolder):
        os.makedirs(dlfolder)

    count=1
    for app in apps:
        filename=app[0] + ".apk"
        print("Downloading[" + str(count) + "/10] " + filename + "...", end='', flush=True)
        file=requests.get(url + app[1])
        open(dlfolder + filename, "wb").write(file.content)
        print(" Done!")
        print("Sha256sum: " + app[1])
        print("")
        count+=1

    print("Downloads completed! Saved to: " + dlfolder)
else:
    print("I found these apps:")
    for app in apps:
        print("App name: " + app[0])
        print("Sha256sum: " + app[1])
        print("")

