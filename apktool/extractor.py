import csv
import subprocess
import os
import xml.etree.ElementTree as ET
import re

android_ns = "{http://schemas.android.com/apk/res/android}"
name_attr = "{0}name".format(android_ns)

permissions = [
    "ACCESS_COARSE_DATA",
    "ACCESS_COARSE_LOCATION",
    "ACCESS_FINE_LOCATION",
    "ACCESS_MOCK_LOCATION",
    "BATTERY_STATS",
    "BLUETOOTH",
    "BLUETOOTH_ADMIN",
    "CALL_PHONE",
    "CAMERA",
    "CHANGE_WIFI_STATE",
    "DISABLE_KEYGUARD",
    "GET_TASKS",
    "INTERNET",
    "MANAGE_ACCOUNTS",
    "NFC",
    "PROCESS_OUTGOING_CALLS",
    "READ_CALENDAR",
    "READ_CONTACTS",
    "READ_EXTERNAL_STORAGE",
    "READ_HISTORY_BOOKMARKS",
    "READ_PHONE_STATE",
    "READ_SMS",
    "RECEIVE_SMS",
    "RECORD_AUDIO",
    "SEND_SMS",
    "SYSTEM_ALERT_WINDOW",
    "WRITE_CONTACTS",
    "WRITE_EXTERNAL_STORAGE",
    "WRITE_HISTORY_BOOKMARKS",
    "WRITE_SMS",
]

def extract_app(app_path, out_path, apktool_path = None):
    if apktool_path == None:
        apktool_path = "apktool"

    if os.path.exists(out_path):
        os.remove(out_path)

    subprocess.run([apktool_path, "d", "-o", out_path, app_path])

def load_manifest(app_path):
    tree = ET.parse(app_path + "/AndroidManifest.xml")
    return tree.getroot()

def get_number_of_activities(manifest):
    number_of_activities = len(manifest.findall("./application/activity"))

    return number_of_activities

def get_permissions(manifest):
    permissions = []

    for permission in manifest.findall("./uses-permission"):
        permissions.append(permission.get(name_attr).split(".")[-1])

    return permissions

def get_ip_files(path):
    matches = []

    files_in_dir = os.listdir(path)

    for file in os.listdir(path):
        filepath = path + os.sep + file
        if os.path.isfile(filepath):
            # Do search in file

            # First run strings command to gen all strings in file
            result = subprocess.run(["strings", filepath], text = True, capture_output = True)

            # Then check for IP addresses
            if string_has_ipv4(result.stdout):
                matches.append(filepath)
        else:
            # Serch recursively in folders
            matches = matches + get_ip_files(filepath)

    return matches

def string_has_ipv4(s):
    ip = re.findall( r'[0-9]+(?:\.[0-9]+){3}', s )

    return len(ip) > 0

def add_csv_line(app_path, extracted_path, csv_path):
    csv_line = []
    manifest = load_manifest(extracted_path)

    file = open(csv_path, "a", newline="")
    csv_out = csv.writer(file, delimiter=",", quotechar="|", quoting=csv.QUOTE_MINIMAL)

    manifest_permissions = get_permissions(manifest)

    # Permissions
    for permission in permissions:
        csv_line.append(1 if permission in manifest_permissions else 0)

    # Num permissions
    csv_line.append(len(manifest_permissions))

    # Number of ips found
    csv_line.append(len(get_ip_files(extracted_path)))

    # TODO: Fix domains found
    csv_line.append(0)

    # TODO: Fix contained files
    csv_line.append(0)

    # TODO: Fix country code
    csv_line.append(0)

    # File size bytes
    csv_line.append(os.path.getsize(app_path))

    # TODO: Fix build year
    csv_line.append(0)

    # TODO: Fix app sha256
    csv_line.append(0)

    # TODO: Fix malware target
    csv_line.append(0)

    # TODO: Fix malware family
    csv_line.append(0)

    csv_out.writerow(csv_line)
