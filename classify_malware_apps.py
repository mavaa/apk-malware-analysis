import json
import os
import re

malware_types = json.load(open("app_data/malwaretypes.json", "r"))

malwaredir = 'app_data/malware_jsons/'

classifications = {}

def add_point(appname, malwaretype):
    print("Give " + appname + " a point in " + malwaretype)
    if not appname in classifications:
        classifications[appname] = {}

    if not malwaretype in classifications[appname]:
        classifications[appname][malwaretype] = 0

    classifications[appname][malwaretype] += 1


for json_filename in os.listdir(malwaredir):
    js_data = json.load(open(malwaredir + json_filename, "r"))
    analysis_data = js_data["data"]["attributes"]["last_analysis_results"]

    for key in analysis_data:
        category = analysis_data[key]["category"]
        result = analysis_data[key]["result"]
        if category == "malicious":
            for malware_type in malware_types:
                if malware_type.lower() in result.lower():
                    add_point(json_filename, malware_type)

                for malware_subtype in malware_types[malware_type]:
                    if malware_subtype.lower() in result.lower():
                        add_point(json_filename, malware_type)

print(classifications)

def write_json(path, data):
    out_file = open(path, "w")
    out_file.write(json.dumps(data, sort_keys=True, indent=4))
    out_file.close()

write_json("classifications.json", classifications)
