import json
import os
from avclass.labeler import AVClassLabeler

json_dir = 'app_data/malware_jsons/'
combined_filename = 'app_data/vt_combined.json'

# Combine all VT files into one file compatible with AVClass
def combine_vt_files():
    with open(combined_filename, 'w') as combined_file:

        for json_filename in os.listdir(json_dir):
            with open(json_dir + json_filename, "r") as json_file:

                for line in json_file:
                    combined_file.write(line.strip())
            combined_file.write('\n')

# This line can be commentted out after running the script once
combine_vt_files()


av_labeler = AVClassLabeler()
av_result = av_labeler.run(
    files=combined_filename,
    data_type="vt3",
    path_export=True
)
av_labels = av_result["labels"]

all_tags = {} # All tags from all apps, grouped by name
top_tags = {} # Tag counts based on top tag per each app (excluding grayware)

for app in av_labels:
    top_tag = ""
    top_tag_count = 0
    tags = app["tags"]

    for tag in tags:
        classification = tag["tag"]
        category = tag["category"]
        count = tag["count"]
        if category == "CLASS":# or category == "FAM":

            if count > top_tag_count and classification != "grayware":
                top_tag = classification
                top_tag_count = count

            if classification not in all_tags:
                all_tags[classification] = 1
            else:
                all_tags[classification] += 1

    if top_tag == '':
        top_tag = "no tag"


    if top_tag not in top_tags:
        top_tags[top_tag] = 1
    else:
        top_tags[top_tag] += 1


print("All tags in apps:")
print(all_tags)
print("Top tags only:")
print(top_tags)
